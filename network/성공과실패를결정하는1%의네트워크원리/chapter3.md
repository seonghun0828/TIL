# 케이블의 앞은 LAN 기기였다

[1. 케이블과 리피터, 허브 속을 신호가 흘러간다](#1-케이블과-리피터-허브-속을-신호가-흘러간다)   
[2. 스위칭 허브의 패킷 중계 동작](#2-스위칭-허브의-패킷-중계-동작)   
[3. 라우터의 패킷 중계 동작](#3-라우터의-패킷-중계-동작)   
[4. 라우터의 부가 기능](#4-라우터의-부가-기능)   

## 1 케이블과 리피터 허브 속을 신호가 흘러간다
    1. 하나하나의 패킷이 독립된 것으로 동작한다
각각의 패킷은 중계되는 동안 데이터 부분은 보여지지 않는다.   
패킷들은 서로 관련 없이 별개의 것으로 간주되어 목적지를 향해 가까이 갈 뿐이다.

    2. LAN 케이블은 신호를 약화시키지 않는 것이 핵심이다
케이블 안에서 이동하는 전기 신호는 다양한 이유로 수있다.   
전압이 급격히 변화하는(주파수가 높은) 신호의 각진 부분은 에너지가 떨어지는 비율이 높아 쉽게 뭉개진다.

    3. '꼼'은 잡음을 방지하기 위한 방법이다
잡음을 방지하기 위해 두 가닥의 신호선을 한 조로 마주 꼰 트위스트 페어 케이블(꼰 선쌍)을 사용한다.   
선을 꼼으로써 외부에서 들어오는 전자파에 의한 잡음을 상쇄시킬 수 있다.   
내부에서도 인접한 신호선에서 누설되는 전자파에 의한 잡음을 상쇄시킬 수 있다.

    4. 리피터 허브는 연결되어 있는 전체 케이블에 신호를 송신한다
신호가 리피터 허브에 도달하면 이더넷의 기본 원리에 따라 LAN 전체에 신호가 흩어진다.   
리피터 허브에서는 LAN 어댑터측과 같이 RJ-45 커넥터에 직접 접속하면 신호를 제대로 수신할 수 없다.   
송신 단자에서 보낸 신호를 수신 단자로 받아야 하므로 허브 안의 PHY(MAU) 회로와 커넥터 사이의 신호선을 교차시켜 접속한다.   
   
MDI와 MDI-X가 있는데 전자는 RJ-45 커넥터와 신호 송수신 회로를 직접 결선한 것이고, 후자는 교차해 결선한 것이다.   
리피터 허브에서 끝의 커넥터에는 MDI/MDI-X 라고 쓰여있는 전환 스위치가 붙어있다. 한쪽이 MDI이면 다른 쪽은 MDI-X여야 한다.    
허브의 커넥터 부분은 보통 MDI-X이므로 허브끼리 접속할 때는 한쪽을 MDI로 설정해야 한다.   
만약 MDI 전환 스위치가 없고 모든 커넥터가 MDI-X인 경우 송신, 수신 단자를 바꿔 들어오게 해주는 크로스 케이블로 허브들을 접속한다.   
   
LAN 어댑터는 허브에만 접속하도록 한정하지 않기 때문에 크로스 케이블은 PC끼리 접속할 때도 사용한다. 
   
리피터 허브에서 PHY(MAU) 회로 수신부에 도달한 신호는 리피터 회로에 들어간다.   
이것을 리피터 허브의 커넥터 부분에 뿌리면 리피터 허브에 접속한 전체 기기에 송신된다.   
리피터 회로의 기본은 신호를 그대로 뿌리는 것이므로 신호가 변형된 것과 상관 없이 그대로 흘려버린다.
    
## 2 스위칭 허브의 패킷 중계 동작
    1. 스위칭 허브는 주소 테이블로 중게한다   
스위칭 허브는 이더넷의 패킷을 그대로 목적지를 향해 중계하도록 만들어져 있다.   
스위칭 허브의 커넥터 안쪽의 회로 부분을 포트라고 부르는데, 포트는 LAN 어댑터와 거의 같은 회로 구조다.   
LAN 어댑터에는 MAC 주소가 할당돼 수신한 패킷의 수신처 MAC 주소가 자신에게 해당하지 않는 경우 패킷을 폐기하지만,   
스위칭 허브의 포트에는 MAC 주소가 할당돼 있지 않으므로 수신처 MAC 주소를 검사하지 않고 모두 수신해 버퍼 메모리에 저장한다는 차이가 있다.   
   
그 다음 수신처 MAC 주소와 일치하는 것이 MAC 주소표에 있는지 조사한다.    
MAC 주소표에는 기기의 MAC 주소와 그 기기가 존재하는 포트 정보가 등록되어 있는데 이것을 사용해 수신한 패킷을 어느 포트에서 송신할지 판단한다.   
포트를 판단하면 스위치 회로를 경유해 패킷을 포트로 보낸다. 스위치 회로 내의 스위치는 각각 독립해 움직이므로 복수의 신호가 동시에 있을 수 있다.   
    
    2. MAC 주소 테이블을 등록 및 갱신한다   
스위칭 허브는 패킷을 중계할 때 MAC 주소표의 내용을 갱신하는 동작도 실행한다.   
그 중 하나는 패킷 수신 시 송신처 MAC 주소를 조사하고 이것을 수신한 입력 포트 번호와 세트로 MAC 주소표에 등록하는 방법이다.   
다른 하나는 MAC 주소표의 오래된 정보는 일정 시간이 경과하면 삭제하는 방법이다. 노트북 등의 기기 이동 시 불편함을 방지해준다.   
혹시 기기가 이동하면서 MAC 주소표에서 해당 정보를 지우기 전에 그곳으로 패킷이 중계된다면,   
스위칭 허브를 리셋해 기존 MAC 주소표를 전부 지우고 새로 정보를 등록하면서 정상 작동이 가능하다.

    3. 예외적인 동작   
만약 패킷을 수신한 포트와 송신할 포트가 같은 경우 스위치 허브는 패킷을 중계하지 않고 폐기한다.   
MAC 주소표에 수신처 MAC 주소와 일치하는 주소가 없는 경우에는 수신한 포트 이외의 전체 포트에 패킷을 송신한다.   
수신처 MAC 주소가 브로드캐스트 주소인 경우 수신 포트를 제외하고 모든 포트에서 패킷을 송신한다.   
브로드캐스트 주소는 LAN의 MAC 주소는 FF:FF:FF:FF:FF:FF 이 되고 IP 주소는 255.255.255.255 가 된다.
    
    4. 전이중 모드에서 송신과 수신을 동시에 실행한다   
스위치 허브의 전이중 모드는 송신과 수신을 동시에 실행한다.   
반이중 모드처럼 송신할 때 신호가 흐르고 있어도 기다릴 필요가 없으므로 더 빠르고 양방향이기에 데이터 양의 상한성도 높아 성능이 좋다.
    
    5. 최적의 전송 속도로 보내는 자동 조정   
이더넷은 데이터가 흐르고 있지 않을 때 링크 펄스라는 펄스형의 신호를 흘린다. 케이블의 단선 등을 확인하기 위한 작업이다.   
여기에 특정 패턴의 펄스 신호를 송신해 자신의 상황(지원 가능한 모드, 전송 속도 등)을 통지하고 그 중 최적의 조합을 선택할 수 있다.
    
    6. 스위칭 허브는 복수의 중계 동작을 동시에 실행한다   
스위칭 허브는 수신처 MAC 주소의 기기가 존재하는 포트 이외에는 송신 동작을 실행하지 않는다.    
다른 포트에서 동시에 패킷을 송수신 할 수 있으므로 동시에 여러 패킷을 중계할 수 있다.
    
## 3 라우터의 패킷 중계 동작
    1. 라우터의 기본   
라우터는 중계 부분과 포트 부분으로 나눠져 있다. 포트 부분은 LAN 어댑터, 무선 LAN, ADSL, FTTH 등 다양한 통신 기술을 지원한다.    
포트 부분에서 패킷을 수신하는데 해당 포트 부분 통신 기술의 규칙에 따른다. 포트 부분의 하드웨어에 의뢰해 패킷을 수신한다고 보면 된다.   
라우터의 각 포트에는 MAC 주소와 IP 주소가 할당되어 있어 패킷의 송수신처가 되어 패킷 송수신 동작을 실행한다.   
스위칭 허브처럼 들어온 패킷을 전송하기만 하는 것이 아니다.

    2. 경로표에 등록된 정보   
스위칭 허브는 MAC 헤더에 기록돼 있는 수신처 MAC 주소로 중계 대상을 판단하지만, 라우터는 IP 헤더의 수신처 IP 주소로 판단한다.   
중계 대상의 주소를 등록하는 테이블도 다른데, 이것을 라우팅 테이블 또는 경로표라고 부른다.   
수신처 | 넷마스크 | 게이트웨이 | 인터페이스 | 메트릭 - 순으로 등록되어 있다.   
   
수신처 항목에는 수신처의 정보가 들어있다. 서브넷 자체를 나타내는 주소인 네트워크 번호와 호스트 번호로 나뉘어 있다.   
1장에서 배운 바와 같이 넷마스크 항목을 통해 네트워크 번호와 호스트 번호의 비트 수를 판단 할 수 있는데 네트워크 번호 부분만 조사한다.   
   
주소 집약이라는 개념을 이용하면 몇 개의 서브넷을 모아 한개의 서브넷으로 간주한 후 묶은 서브넷을 경로표에 등록할 수 있다.   
10.10.1.0/24 , 10.10.2.0/24 , 10.10.3.0/24 이 세 서브넷들을 10.10.0.0/16 이라는 서브넷으로 통합할 수 있다.   
반대로 한 개의 서브넷을 세분화해 경로표에 등록하고, 복수의 서브넷이 있는 것처럼 보이는 경우도 있다.   
결국 라우터 경로표의 넷마스크 항목은 경로표의 수신처와 패킷의 수신처 주소를 대조할 때 비트 수를 나타내는 것이다.   
   
게이트웨이와 인터페이스 항목은 패킷의 중계 대상을 나타낸다. 우선 경로표에서 수신처와 넷마스크 항목을 통해 해당 행을 찾아낸다.    
그 행에 등록돼 있는 인터페이스(포트)에서 게이트웨이 항목에 등록돼 있는 IP 주소를 가진 라우터에 패킷을 중계한다.   
메트릭은 수신처 IP 주소에 기록돼 있는 목적지가 가까운지 먼지를 나타낸다. 숫자가 작을수록 가까운 것이다.   
   
스위칭 허브는 패킷 중계 동작의 일환으로 MAC 주소 테이블에 정보를 등록하는 동작을 실행하지만 라우터는 패킷 중계만 한다.   
라우터가 경로 정보를 등록하거나 갱신하는 동작은 패킷 중계 동작과 분리되어 있다.   
사람이 수동으로 경로 정보를 등록/갱신 하거나 라우팅 프로토콜이라는 구조를 사용해 라우터끼리 정보를 교환하며 자체 등록한다.
    
    3. 라우터의 패킷 수신 동작   
라우터의 포트에는 MAC 주소가 할당되어 있으며, 라우터는 자신의 주소에 해당하는 패킷만 수신하고 해당하지 않는 패킷은 폐기한다.
    
    4. 경로표를 검색하여 출력 포트를 발견한다   
라우터에서 수신한 패킷의 수신처 MAC 주소에는 해당 라우터의 포트에 할당된 MAC 주소가 기록되어 있다.   
그 MAC 주소는 해당 라우터에 도달한 순간 역할이 끝나기 때문에 MAC 헤더를 폐기하고, MAC 헤더 뒤의 IP 헤더의 내용을 확인한다.   
먼저 패킷의 수신처 IP 주소와 경로표의 수신처 항목의 네트워크 번호 부분을 비교해 조사해 해당하는 행을 찾는다.    
해당하는 것이 복수의 행일 수도 있는데, 그 중 네트워크 번호의 비트수가 가장 긴 것을 찾는다.   
   
복수의 해당 행들은 모두 네트워크 번호가 같으므로 우선 같은 서브넷 안에 속해있다는 뜻이다.   
그런데 그 중 네트워크 번호의 비트 수가 길다는 것은 그만큼 호스트 번호의 비트 수는 짧다는 뜻이고,   
이것은 호스트 번호로 할당 가능한, 서브넷에 접속 가능한 컴퓨터의 수가 적다는 뜻이므로 더 좁은 범위를 의미한다.   
그러므로 중계 대상을 정확하게 판단할 수 있는 것이다.
    
네트워크 길이가 같은 것이 여러 행 존재하는 경우는 메트릭 값이 작은 쪽을 중계 대상으로 선택한다.   
해당하는 행이 하나도 발견되지 않는 경우는 패킷을 폐기하고, ICMP 메시지로 송신처에 이 사실을 통지한다.   
스위칭 허브와 달리 라우터의 네트워크 규모는 너무 크기 때문에 모든 포트에 패킷을 뿌리지 않고 그냥 폐기하는 것이다.
    
    5. 해당하는 경로가 없는 경우에 선택하는 기본 경로    
넷마스크가 0.0.0.0 이라는 것은 패킷의 수신처 IP 주소와 경로표의 수신처 항목을 비교할 때 비트 수가 0이라는 것이므로 비교하지 않는다.   
모든 주소와 일치하기 때문이다. 이 항목은 네트워크 비트 수가 가장 적기 때문에 비교할 때 가장 나중에 선택된다.   
즉 해당하는 경로가 없는 경우에 이 항목이 선택되며 이 행의 '게이트웨이' 항목에 인터넷으로 나가는 라우터를 등록해 두면 그곳으로 중계한다.   
이 행을 ***기본 경로***라고 하며, 여기에 등록한 라우터를 ***기본 게이트웨이***라고 한다.
    
    6. 패킷은 유효 기한이 있다   
경로표에서 중계대상을 찾아내면 라우터는 TTL(Time To Live) 라는 IP 헤더의 필드를 갱신한다.   
패킷이 같은 장소를 계속 순환하는 것을 막기 위한 것으로, 라우터를 경유할 때마다 1씩 줄여 0이되면 패킷을 폐긴한다.
    
    7. 큰 패킷은 조각 나누기 기능으로 분할한다   
입력으로 드러온 패킷의 최대 길이보다 출력의 최대 길이가 더 작아 패킷을 그대로 송신할 수 없을 때 조각 나누기(fragmentation)을 한다.   
2장에서 설명한 TCP가 데이터를 분할하는 것과는 다른데, TCP는 데이터를 저장하기 전에 분할해 나눠진 데이터 조각을 한 개의 패킷에 저장한다.   
   
반면, 라우터의 조각 나누기는 패킷이 만들어진 후 패킷을 분할한다. 패킷을 분할할 수 없으면 패킷을 폐기하고 ICMP 메시지로 송신처에 통지한다.   
패킷을 분할할 때 IP 입장에서 TCP도 송신을 의뢰받은 부분이므로 데이터로 간주한다.   
그래서 TCP를 포함해 데이터를 나누고 각 패킷에 MAC 헤더와 IP 헤더를 추가한다.
    
    8. 라우터의 송신 동작은 컴퓨터와 같다   
이제 패킷의 송신 동작으로 넘어간다. 이 때 동작은 출력 측의 포트에 따라 다르다. 포트가 이더넷인 경우의 송신 동작을 설명하겠다.   
이더넷의 패킷 송신 동작은 프로토콜 스택의 IP 담당 부분이 패킷을 보낼 때와 같다.   
   
MAC 헤더 맨 앞의 수신처 MAC 주소 필드에 값을 설정하기 위해 경로표의 '게이트웨이' 항목에서 패킷을 건네줄 상대를 판단한다.   
게이트웨이 항목에 IP 주소가 쓰여있으면 그 IP 주소가 상대가 되고, 공란이면 IP 헤더의 수신처 IP 주소가 건네줄 상대가 된다.   
IP 주소가 결정되면 ARP로 IP 주소에서 MAC 주소를 조사하고, 그 결과를 수신처 MAC 주소로 설정한다.   
   
송신처 MAC 주소는 출력 측의 포트에 할당된 MAC 주소를 설정하고 타입 필드에 0800(16진수)를 설정한다.   
이제 송신 패킷이 만들어졌으므로 전기 신호로 변환해서 포트에 송신하는데 이 동작도 컴퓨터와 같다.   
반이중, 전이중 모드에 맞게 신호를 송신한다.
    
    9. 라우터와 스위칭 허브의 관계
IP라는 구조는 스스로 패킷을 운반하는 수단이 없으므로 패킷을 운반할 때는 이더넷에 의뢰하여 운반한다.   
라우터는 IP 개념에 기초해, 스위칭 허브는 이더넷에 기초해 만들어졌으므로 라우터와 스위칭 허브의 관계도 동일하다.
    
## 4 라우터의 부가 기능
    1. 주소 변환으로 IP 주소를 효율적으로 이용한다   
    
    2. 주소 변환의 기본 동작   
    
    3. 포트 번호를 바꿔쓰는 이유   
    
    4. 인터넷에서 회사로 액세스한다   
    
    5. 라우터의 패킷 필터링 기능
    
